{"version":3,"sources":["../../app/helpers/base.js"],"names":["chance","require","module","exports","Base","constructor","settings","utils","messagingChannel","actions","MessagingChannel","statuses","_attacher","service_name","process","env","npm_package_name","_getAttacher","attacher_name","TypeError","findLast","name","registerServiceName","registerAttacher","attacher","push","model","schema_name","schema","services_to","Error","options","_servicesToMapper","_attachToAttacher","self","current_service","map","service","create","update","delete","isPlainObject","value","modelReceive","receiver","_init","ask","action","payload","Promise","resolve","correlation","geohash","rpc_client","response","JSON","parse","content","toString","answer","callback","rpc_server","msg","channel","callback_result","sendToQueue","properties","replyTo","Buffer","stringify","correlationId","ack"],"mappings":"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","file":"base.js","sourcesContent":["import statuses               from './statuses.helper';\r\nimport { MessagingChannel }   from './channel.helper';\r\nimport { MessagingAction }    from './action.helper';\r\nimport { MessagingUtil }      from './util.helper';\r\nimport _ from 'lodash';\r\n\r\nlet chance = require('chance');\r\n\r\nmodule.exports  = class Base{\r\n    constructor({settings}){\r\n        this.utils = new MessagingUtil();\r\n        this.settings = settings;\r\n        this.messagingChannel = new MessagingChannel({ utils: this.utils });\r\n        this.actions = new MessagingAction({ settings: this.settings, utils: this.utils, MessagingChannel: this.messagingChannel });\r\n        this.statuses = statuses;\r\n        this._attacher = [];\r\n        this.service_name = process.env.npm_package_name;\r\n        \r\n        this.chance = new chance;\r\n    }\r\n    \r\n    _getAttacher(attacher_name){\r\n        if(!attacher_name){\r\n            throw new TypeError('attacher_name is not defined')\r\n        }\r\n\r\n        return _.findLast(this._attacher, { name: attacher_name })\r\n    }\r\n  \r\n    /** \r\n    * Register the current service name\r\n    */\r\n    registerServiceName(service_name){\r\n        if(!service_name){\r\n            throw new TypeError('service_name is not defined')\r\n        }\r\n\r\n        return this.service_name = service_name;\r\n    }\r\n    \r\n    /**\r\n     * Add attacher to singleton\r\n     *\r\n     * @param {string} name Attachers name\r\n     * @param {object} attacher Object\r\n     */\r\n    registerAttacher(name, attacher){\r\n\r\n        if(!name){\r\n            throw new TypeError('name is not defined')\r\n        }\r\n\r\n        if(!attacher){\r\n            throw new TypeError('attacher is not defined')\r\n        }\r\n\r\n        this._attacher.push({\r\n            name,\r\n            attacher\r\n        })\r\n    }\r\n    \r\n    /**\r\n     * Model to send\r\n     *\r\n     * @param {string} attacher_name\r\n     * @param {string} schema Model schema\r\n     * @param {string} services Services to send the message to\r\n     */\r\n    model(attacher_name, schema_name, schema, services_to){\r\n        if(!attacher_name){\r\n            throw new Error('Attacher name is empty')\r\n        }\r\n        if(!schema_name){\r\n            throw new Error('Schema name is empty')\r\n        }\r\n        if(!schema){\r\n            throw new Error('Schema is empty')\r\n        }\r\n        if(!services_to){\r\n            throw new Error('Services to send is empty')\r\n        }\r\n        let attacher = this._getAttacher(attacher_name);\r\n        \r\n        let options = services_to;\r\n        services_to = this._servicesToMapper(services_to);\r\n        \r\n        this._attachToAttacher(attacher, schema_name, schema, services_to, options);\r\n    }\r\n    \r\n    _attachToAttacher(attacher, schema_name, schema, services_to, options){\r\n\r\n        if(!attacher){\r\n            throw new Error('attacher is not defined')\r\n        }\r\n\r\n        if(!schema_name){\r\n            throw new Error('schema_name is not defined')\r\n        }\r\n\r\n        if(!schema){\r\n            throw new Error('schema is not defined')\r\n        }\r\n\r\n        if(!services_to){\r\n            throw new Error('services_to is not defined')\r\n        }\r\n\r\n        let self = this;\r\n        let current_service = this.service_name;\r\n        \r\n        _.map(services_to, service=>{\r\n            attacher.attacher.create(`create_${schema_name}_from_${current_service}_for_${service}`, schema_name, current_service, service, schema, self, options)\r\n            attacher.attacher.update(`update_${schema_name}_from_${current_service}_for_${service}`, schema_name, current_service, service, schema, self, options)\r\n            attacher.attacher.delete(`delete_${schema_name}_from_${current_service}_for_${service}`, schema_name, current_service, service, schema, self, options)\r\n        })\r\n    }\r\n    \r\n    // Get all services name and map it into single array\r\n    _servicesToMapper(services_to){\r\n        if(!services_to){\r\n            throw new Error('services_to is not defined')\r\n        }\r\n        return _(services_to).map(service => {\r\n            if (_.isPlainObject(service)) {\r\n                if (service.name) {\r\n                    return service.name;\r\n                }\r\n                throw new Error('Name is not defined in object');\r\n            }\r\n            return service;\r\n        }).value();\r\n    }\r\n    \r\n    /**\r\n    * Receiver from model entity\r\n    */\r\n    modelReceive(receiver){\r\n        if(!receiver){\r\n            throw new TypeError('receiver is not defined')\r\n        }\r\n        receiver._init(this);\r\n    }\r\n    \r\n    ask(service, action, payload){\r\n        if(!service){\r\n            throw new TypeError('service is not defined')\r\n        }\r\n        if(!action){\r\n            throw new TypeError('action is not defined')\r\n        }\r\n        if(!payload){\r\n            throw new TypeError('payload is not defined')\r\n        }\r\n        return new Promise(resolve=>{\r\n            let correlation = this.chance.geohash()\r\n            this.actions.rpc_client(`ask_${action}_from_${service}`, payload, correlation, response=>{\r\n                resolve(JSON.parse(response.content.toString()))\r\n            })\r\n        })\r\n    }\r\n    \r\n    answer(action, callback){\r\n        if(!action){\r\n            throw new TypeError('action is not defined')\r\n        }\r\n        if(!callback){\r\n            throw new TypeError('callback is not defined')\r\n        }\r\n        this.actions.rpc_server(`ask_${action}_from_${this.service_name}`, async(msg, channel)=>{\r\n            let callback_result = await callback(JSON.parse(msg.content.toString()));\r\n            if(!callback_result){\r\n                callback_result = true;\r\n            }\r\n            channel.sendToQueue(msg.properties.replyTo, new Buffer(JSON.stringify(callback_result)), {correlationId: msg.properties.correlationId})\r\n            channel.ack(msg)\r\n        })\r\n    }\r\n\r\n}\r\n"]}